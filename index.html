<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Blaze Apostas Online | Blaze Jogo | Crash & Double | Blaze</title>
    
    <link rel="icon" href="https://blaze.bet.br/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" href="https://blaze.bet.br/favicon.ico" />

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" integrity="sha512-1ycn6IcaQQ40/MKBW2W4Rhis/DbILU74C1vSrLJxCq57o941Ym01SwNsOMqvEBFlcgUa6xLiPY/NS5R+E6ztJQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <link rel="stylesheet" href="style.css" />
</head>
<body>
    <div class="login-screen">
        <div class="login-box-blaze">
            <img src="https://blaze.bet.br/static/media/logo.cf45d2ad.svg" alt="Logo" class="logo-blaze" />
            <input type="password" id="senha" placeholder="Senha" onkeydown="if(event.key==='Enter') entrarNoChat()" />
            <button onclick="entrarNoChat()">Entrar</button>
        </div>
    </div>

    <div class="container" id="chatContainer" style="display: none;">
        <div class="chat-header">
            <h2>E vocÃª chegou ðŸŽµ</h2>
        </div>
        <div class="chat-mensajes" id="chatMensajes"></div>
        <div id="typing-indicator"></div>
        <div class="progress-bar" id="progressBar"><div class="progress" id="progress"></div></div>
        <div class="chat">
            <div class="chat-input-wrapper">
                <input type="text" id="chatInput" placeholder="Escreva uma mensagem..." onkeydown="handleKeydown(event)">
                <input type="file" id="fileInput" accept="image/*" style="display:none" onchange="uploadFoto(this)">
                <button id="fotoBtn" class="action-btn" onclick="document.getElementById('fileInput').click()">
                    <i class="fas fa-paperclip"></i>
                </button>
                <button id="enviarBtn" class="action-btn" onclick="enviarMensagem()">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <div id="popupImagem" onclick="fecharPopup()">
        <div id="popupConteudo" onclick="event.stopPropagation()">
            <span id="fecharBtn" onclick="fecharPopup()">&times;</span>
            <img id="popupImg" />
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDfBpJ-5DhknC9QRdSj8O1ShdJwBiL8284",
            authDomain: "chat-ele-ela.firebaseapp.com",
            projectId: "chat-ele-ela",
            storageBucket: "chat-ele-ela.appspot.com",
            messagingSenderId: "1019858101951",
            appId: "1:1019858101951:web:5fba5a102d67d9009c880a"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const loginScreen = document.querySelector('.login-screen');
        const chatContainer = document.getElementById('chatContainer');
        const senhaInput = document.getElementById('senha');
        const chatMensajes = document.getElementById('chatMensajes');
        const chatInput = document.getElementById('chatInput');
        const progressBar = document.getElementById('progressBar');
        const progress = document.getElementById('progress');
        const typingIndicator = document.getElementById('typing-indicator');
        let usuario = "";
        let otherUser = "";
        let typingTimeout;

        function entrarNoChat() {
            const senha = senhaInput.value.trim();
            if (senha === "14141516") { usuario = "Ele"; otherUser = "Ela"; } 
            else if (senha === "170125") { usuario = "Ela"; otherUser = "Ele"; } 
            else if (senha === "4444") { window.location.href = "https://blaze.com"; return; } 
            else { alert("Senha incorreta"); return; }

            loginScreen.style.display = "none";
            chatContainer.style.display = "flex";
            carregarMensagens();
            setupTypingListeners();
        }

        function carregarMensagens() {
            db.ref("mensagens").orderByChild("timestamp").on("value", snapshot => {
                chatMensajes.innerHTML = "";
                if (!snapshot.exists()) return;

                snapshot.forEach(childSnapshot => {
                    const id = childSnapshot.key;
                    const data = childSnapshot.val();
                    const msg = criarElementoMensagem(id, data);
                    chatMensajes.appendChild(msg);
                });

                // SCROLL CORRIGIDO: Se usa setTimeout para asegurar que el DOM se actualice antes de hacer scroll.
                setTimeout(() => {
                    chatMensajes.scrollTop = chatMensajes.scrollHeight;
                }, 0);
            });
        }
        
        function criarElementoMensagem(id, data) {
            const hora = new Date(data.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            const dataFormatada = new Date(data.timestamp).toLocaleDateString();
            const msg = document.createElement("div");
            msg.className = `mensagem ${data.usuario === "Ele" ? 'ele' : 'ela'}`;
            msg.dataset.id = id;
            let contentHTML = data.imagemUrl 
                ? `<img src="${data.imagemUrl}" onclick="abrirPopup('${data.imagemUrl}')">` 
                : data.mensagem.replace(/</g, "&lt;").replace(/>/g, "&gt;");
            const reactionsHTML = data.reactions ? Object.entries(data.reactions).map(([e, c]) => `${e} ${c}`).join(' ') : '';
            const reactionPickerHTML = `<div class="reaction-picker">...</div>`;
            msg.innerHTML = `${contentHTML}<div class="hora">${dataFormatada} ${hora}</div>${reactionsHTML ? `<div class="reactions">${reactionsHTML}</div>` : ''}`;
            return msg;
        }

        function handleKeydown(event) {
            db.ref(`typing/${usuario}`).set(true);
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => db.ref(`typing/${usuario}`).set(false), 2000);
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                enviarMensagem();
            }
        }
        
        function enviarMensagem() {
            const texto = chatInput.value.trim();
            if (texto === "") return;
            db.ref("mensagens").push({
                usuario: usuario,
                mensagem: texto,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });
            chatInput.value = "";
            db.ref(`typing/${usuario}`).set(false);
            chatInput.focus();
        }
        
        function setupTypingListeners() {
            db.ref(`typing/${otherUser}`).on('value', s => {
                typingIndicator.textContent = s.val() ? `${otherUser} estÃ¡ escrevendo...` : "";
            });
        }
        
        function uploadFoto(input) {
            const file = input.files[0];
            if (!file) return;
            const formData = new FormData();
            formData.append("image", file);
            progressBar.style.display = 'block';
            progress.style.width = '0%';
            const xhr = new XMLHttpRequest();
            xhr.open("POST", "https://api.imgur.com/3/image");
            xhr.setRequestHeader("Authorization", "Client-ID 9c2d72d1a0c3b0b");
            xhr.upload.onprogress = e => {
                if (e.lengthComputable) progress.style.width = (e.loaded / e.total) * 100 + "%";
            };
            xhr.onload = () => {
                progressBar.style.display = 'none';
                try {
                    const res = JSON.parse(xhr.responseText);
                    if (res.success) {
                        db.ref("mensagens").push({
                            usuario: usuario,
                            imagemUrl: res.data.link,
                            timestamp: firebase.database.ServerValue.TIMESTAMP
                        });
                    } else { alert("Erro ao enviar imagem."); }
                } catch (e) { alert("Erro no upload."); }
            };
            xhr.onerror = () => { progressBar.style.display = 'none'; alert("Erro de conexÃ£o."); };
            xhr.send(formData);
        }

        function abrirPopup(url) {
            document.getElementById('popupImg').src = url;
            document.getElementById('popupImagem').style.display = 'flex';
        }

        function fecharPopup() {
            document.getElementById('popupImagem').style.display = 'none';
        }
    </script>
</body>
</html>
